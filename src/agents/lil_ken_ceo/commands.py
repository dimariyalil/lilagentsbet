"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –¥–ª—è CEO –∞–≥–µ–Ω—Ç–∞
"""
from datetime import datetime, timedelta
from typing import Optional

from .prompts import CEO_PROMPTS
from utils.logger import setup_logger

logger = setup_logger("ceo_commands")


class CEOCommands:
    """–ö–æ–º–∞–Ω–¥—ã CEO –∞–≥–µ–Ω—Ç–∞"""
    
    def __init__(self, agent):
        self.agent = agent
    
    async def year_strategy(self) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–æ–¥–æ–≤–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏"""
        prompt = CEO_PROMPTS["year_strategy"]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
        knowledge = await self.agent.knowledge.search("–≥–æ–¥–æ–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –±–∏–∑–Ω–µ—Å –ø–ª–∞–Ω")
        
        full_prompt = f"{prompt}\n\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:\n{knowledge}"
        
        response = await self.agent._get_ai_response(full_prompt)
        return response
    
    async def market_analysis(self, country: str) -> str:
        """–ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞ —Å—Ç—Ä–∞–Ω—ã"""
        prompt = CEO_PROMPTS["market_analysis"].format(country=country)
        
        # –ò—â–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç—Ä–∞–Ω–µ
        knowledge = await self.agent.knowledge.search(f"–≥–µ–º–±–ª–∏–Ω–≥ —Ä—ã–Ω–æ–∫ {country}")
        
        full_prompt = f"{prompt}\n\n–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä—ã–Ω–∫–µ:\n{knowledge}"
        
        response = await self.agent._get_ai_response(full_prompt)
        return response
    
    async def competitor_watch(self) -> str:
        """–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤"""
        prompt = CEO_PROMPTS["competitor_watch"]
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞—Ö
        knowledge = await self.agent.knowledge.search("–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–Ω–∞–ª–∏–∑ –≥–µ–º–±–ª–∏–Ω–≥")
        
        full_prompt = f"{prompt}\n\n–î–∞–Ω–Ω—ã–µ –æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞—Ö:\n{knowledge}"
        
        response = await self.agent._get_ai_response(full_prompt)
        return response
    
    async def swot_analysis(self) -> str:
        """SWOT –∞–Ω–∞–ª–∏–∑ –∫–æ–º–ø–∞–Ω–∏–∏"""
        prompt = """–ü—Ä–æ–≤–µ–¥–∏ –¥–µ—Ç–∞–ª—å–Ω—ã–π SWOT –∞–Ω–∞–ª–∏–∑ –Ω–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞:
1. Strengths (–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã)
   - –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
   - –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏
   - –†–µ—Å—É—Ä—Å—ã –∏ –∞–∫—Ç–∏–≤—ã

2. Weaknesses (–°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã)
   - –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
   - –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤

3. Opportunities (–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)
   - –í–Ω–µ—à–Ω–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã —Ä–æ—Å—Ç–∞
   - –†—ã–Ω–æ—á–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã
   - –ù–æ–≤—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

4. Threats (–£–≥—Ä–æ–∑—ã)
   - –í–Ω–µ—à–Ω–∏–µ —Ä–∏—Å–∫–∏
   - –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ —É–≥—Ä–æ–∑—ã
   - –†–µ–≥—É–ª—è—Ç–æ—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

–°–¥–µ–ª–∞–π –≤—ã–≤–æ–¥—ã –∏ –¥–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.
"""
        response = await self.agent._get_ai_response(prompt)
        return response
    
    async def risk_assessment(self) -> str:
        """–û—Ü–µ–Ω–∫–∞ –±–∏–∑–Ω–µ—Å-—Ä–∏—Å–∫–æ–≤"""
        prompt = """–ü—Ä–æ–≤–µ–¥–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –æ—Ü–µ–Ω–∫—É —Ä–∏—Å–∫–æ–≤ –±–∏–∑–Ω–µ—Å–∞.

–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∏—Å–∫–æ–≤:
1. –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∏—Å–∫–∏
   - –í–∞–ª—é—Ç–Ω—ã–µ —Ä–∏—Å–∫–∏
   - –ö—Ä–µ–¥–∏—Ç–Ω—ã–µ —Ä–∏—Å–∫–∏
   - –õ–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å

2. –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∏—Å–∫–∏
   - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–±–æ–∏
   - –ß–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π —Ñ–∞–∫—Ç–æ—Ä
   - –ü—Ä–æ—Ü–µ—Å—Å–Ω—ã–µ —Ä–∏—Å–∫–∏

3. –†–µ–≥—É–ª—è—Ç–æ—Ä–Ω—ã–µ —Ä–∏—Å–∫–∏
   - –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞
   - –õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–µ —Ä–∏—Å–∫–∏
   - –®—Ç—Ä–∞—Ñ—ã –∏ —Å–∞–Ω–∫—Ü–∏–∏

4. –†–µ–ø—É—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∏—Å–∫–∏
   - –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –æ—Ç–∑—ã–≤—ã
   - –°–∫–∞–Ω–¥–∞–ª—ã
   - –ü—Ä–æ–±–ª–µ–º—ã —Å –≤—ã–ø–ª–∞—Ç–∞–º–∏

5. –°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏
   - –ù–µ–≤–µ—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è
   - –£–ø—É—â–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
   - –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ —É–≥—Ä–æ–∑—ã

–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∏—Å–∫–∞ —É–∫–∞–∂–∏:
- –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å (1-5)
- –í–ª–∏—è–Ω–∏–µ (1-5)
- –ú–µ—Ä—ã –º–∏—Ç–∏–≥–∞—Ü–∏–∏
- –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π
"""
        response = await self.agent._get_ai_response(prompt)
        return response
    
    async def daily_report(self) -> str:
        """–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç"""
        # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        prompt = CEO_PROMPTS["daily_report"]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤—á–µ—Ä–∞—à–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏ (–∑–∞–≥–ª—É—à–∫–∞)
        yesterday = (datetime.now() - timedelta(days=1)).strftime("%Y-%m-%d")
        metrics = f"""
–ú–µ—Ç—Ä–∏–∫–∏ –∑–∞ {yesterday}:
- –í—ã—Ä—É—á–∫–∞: $85,420 (–ø–ª–∞–Ω: $83,333, +2.5%)
- –ù–æ–≤—ã–µ –∏–≥—Ä–æ–∫–∏: 142 (–ø–ª–∞–Ω: 150, -5.3%)
- –î–µ–ø–æ–∑–∏—Ç—ã: 1,247
- –°—Ä–µ–¥–Ω–∏–π –¥–µ–ø–æ–∑–∏—Ç: $68.5
- –ê–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä–æ–∫–∏: 12,453
"""
        full_prompt = f"{prompt}\n\n{metrics}"
        
        response = await self.agent._get_ai_response(full_prompt)
        return response
    
    async def weekly_report(self) -> str:
        """–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç"""
        prompt = CEO_PROMPTS["weekly_report"]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (–∑–∞–≥–ª—É—à–∫–∞)
        week_data = """
–ù–µ–¥–µ–ª—å–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (19-25 —è–Ω–≤–∞—Ä—è):
- –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞: $598,940 (–ø–ª–∞–Ω: $583,333, +2.7%)
- –ù–æ–≤—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: 1,024
- –°—Ä–µ–¥–Ω–∏–π LTV –Ω–æ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤: $412
- Retention D7: 42%
- Churn rate: 18%
"""
        full_prompt = f"{prompt}\n\n{week_data}"
        
        response = await self.agent._get_ai_response(full_prompt)
        return response
    
    async def status(self) -> str:
        """–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã"""
        status_text = f"""
üü¢ **–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã lil_ken_ceo**

**–ê–≥–µ–Ω—Ç:** –ê–∫—Ç–∏–≤–µ–Ω
**–í–µ—Ä—Å–∏—è:** 1.0.0
**Uptime:** 24—á 15–º

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- AI Engine: ‚úÖ Claude 3 Opus
- –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π: ‚úÖ {await self.agent.knowledge.get_doc_count()} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –ü–∞–º—è—Ç—å: ‚úÖ Redis –∞–∫—Ç–∏–≤–µ–Ω
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: ‚úÖ PostgreSQL –∞–∫—Ç–∏–≤–µ–Ω

**–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:**
- –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞–ø—Ä–æ—Å–æ–≤: 142
- –°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞: 2.3 —Å–µ–∫
- –û—à–∏–±–æ–∫ –∑–∞ —Å—É—Ç–∫–∏: 0

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:**
- n8n: ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω
- Telegram: ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω

–í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ.
"""
        return status_text